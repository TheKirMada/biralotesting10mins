name: start-vps

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart-vps]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # Try restoring backup if it exists
      - name: Restore previous backup if available
        run: |
          if [ -f last-backup-url.txt ]; then
            url=$(cat last-backup-url.txt)
            echo "Restoring backup from $url..."
            curl -sL $url -o full-backup.tar.gz
            sudo tar -xzf full-backup.tar.gz -C /
            echo "Backup restored ✅"
          else
            echo "No backup found, starting fresh ❌"
          fi

      - name: Keep VPS alive (13m loop)
        run: |
          echo "Starting VPS keep-alive loop..."
          for i in {1..13}; do
            echo "Running minute $i/13..."
            sleep 60
          done

      - name: Final backup before timeout
        if: always()
        run: |
          echo "Creating FULL backup archive..."
          sudo tar -czf full-backup.tar.gz --exclude=.git --exclude=full-backup.tar.gz /
          echo "Uploading backup..."
          curl -s --upload-file ./full-backup.tar.gz https://transfer.sh/full-backup.tar.gz > backup-link.txt
          cat backup-link.txt > last-backup-url.txt
          echo "✅ Backup uploaded and URL saved"

      - name: Pull latest changes (avoid push rejection)
        if: always()
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "GitHub Actions"
          git pull --rebase || true
          git add last-backup-url.txt || true
          git commit -m "Update backup URL" || true
          git push || true

      - name: Save SSH link + backup URL
        if: always()
        run: |
          echo "Backup URL:"
          cat backup-link.txt || echo "No backup created"

      - name: Restart workflow automatically
        if: always()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          event-type: restart-vps
